name: A Better World CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  desktop:
    name: ğŸ–¥ï¸ Desktop Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸ§± Build Core Library (abetterworld)
        run: cargo build -p abetterworld --verbose

      - name: ğŸ§± Build Desktop App
        run: cargo build -p desktop --verbose

      - name: âœ… Run Native Tests
        run: cargo test --manifest-path abetterworld/Cargo.toml --features paging_test -- --test-threads=1

  web:
    name: ğŸŒ Web Build & Test (WASM)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸ“¡ Add WebAssembly target
        run: rustup target add wasm32-unknown-unknown

      - name: ğŸ”§ Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: ğŸ“¦ Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli

      - name: ğŸ§± Build Web App
        run: make build-web

      - name: ğŸŒ Run Web Tests (Firefox Headless)
        run: make test-web

  android:
    name: ğŸ¤– Android Build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸ“¦ Install cargo-ndk
        run: cargo install cargo-ndk

      - name: ğŸ“¦ Add Android targets
        run: |
          rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android

      - name: ğŸ“¦ Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: ğŸ›  Fix NDK env for cargo-ndk
        run: echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV

      - name: ğŸ§° Install OpenSSL 3
        run: sudo apt-get update && sudo apt-get install -y libssl-dev

      - name: ğŸ“± Build for Android
        env:
          OPENSSL_STATIC: "1"
          OPENSSL_NO_VENDOR: "0"
        run: make build-android-debug

  ios:
    name: ğŸ iOS Build
    runs-on: self-hosted
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸ“¦ Add iOS targets
        run: |
          rustup target add aarch64-apple-ios x86_64-apple-ios aarch64-apple-ios-sim

      - name: ğŸ§± Build iOS xcframework (Debug)
        run: make build-ios-debug
